generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum RecurrenceType {
  NONE
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

// A Household is the top-level organizational unit
// Multiple users can belong to a household and share budgets, accounts, and categories
model Household {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  // Relations
  users      HouseholdUser[]
  budgets    Budget[]
  categories Category[]
  accounts   Account[]
  recipients Recipient[]
  invitations Invitation[]

  @@index([createdAt])
}

// Join table for many-to-many relationship between Users and Households
// A user can belong to multiple households
model HouseholdUser {
  id          String   @id @default(cuid())
  userId      String   // Clerk user ID
  householdId String
  joinedAt    DateTime @default(now())

  // Relations
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, householdId])
  @@index([userId])
  @@index([householdId])
}

model Budget {
  id          String   @id @default(cuid())
  name        String
  startDate   DateTime
  householdId String
  createdAt   DateTime @default(now())

  // Relations
  household    Household         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  categories   BudgetCategory[]  // Many-to-many with Category
  accounts     BudgetAccount[]   // Many-to-many with Account
  transactions Transaction[]
  bills        Bill[]
  transfers    Transfer[]
  incomes      Income[]

  @@index([householdId])
  @@index([createdAt])
}

model Category {
  id          String       @id @default(cuid())
  name        String
  type        CategoryType
  householdId String
  createdAt   DateTime     @default(now())

  // Relations
  household    Household        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  budgets      BudgetCategory[] // Many-to-many with Budget
  transactions Transaction[]
  bills        Bill[]
  incomes      Income[]

  @@index([householdId])
  @@index([type])
}

model Account {
  id                 String   @id @default(cuid())
  name               String
  externalIdentifier String?  // Optional external account number
  initialBalance     Float    @default(0)
  householdId        String
  createdAt          DateTime @default(now())
  isArchived         Boolean  @default(false)

  // Relations
  household     Household       @relation(fields: [householdId], references: [id], onDelete: Cascade)
  budgets       BudgetAccount[] // Many-to-many with Budget
  transactions  Transaction[]
  bills         Bill[]
  transfersFrom Transfer[]      @relation("TransferFrom")
  transfersTo   Transfer[]      @relation("TransferTo")
  incomes       Income[]

  @@index([householdId])
}

// Join table for Budget ↔ Category many-to-many relationship
model BudgetCategory {
  id         String @id @default(cuid())
  budgetId   String
  categoryId String

  // Relations
  budget   Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([budgetId, categoryId])
  @@index([budgetId])
  @@index([categoryId])
}

// Join table for Budget ↔ Account many-to-many relationship
model BudgetAccount {
  id        String @id @default(cuid())
  budgetId  String
  accountId String

  // Relations
  budget  Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([budgetId, accountId])
  @@index([budgetId])
  @@index([accountId])
}

model Transaction {
  id          String   @id @default(cuid())
  name        String
  amount      Float
  date        DateTime
  notes       String?
  categoryId  String
  accountId   String
  budgetId    String
  billId      String?  // Optional link to bill
  recipientId String?  // Optional link to recipient (used for both recipients and senders)
  incomeId    String?  // Optional link to planned income
  createdAt   DateTime @default(now())

  // Relations
  category  Category   @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  account   Account    @relation(fields: [accountId], references: [id], onDelete: Restrict)
  budget    Budget     @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  bill      Bill?      @relation(fields: [billId], references: [id], onDelete: SetNull)
  recipient Recipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  income    Income?    @relation(fields: [incomeId], references: [id], onDelete: SetNull)

  @@index([budgetId])
  @@index([categoryId])
  @@index([accountId])
  @@index([billId])
  @@index([recipientId])
  @@index([incomeId])
  @@index([date])
}

model Bill {
  id                 String         @id @default(cuid())
  name               String
  recipient          String
  accountId          String
  startDate          DateTime       // First payment date
  recurrenceType     RecurrenceType @default(NONE)
  customIntervalDays Int?           // For CUSTOM recurrence
  estimatedAmount    Float
  lastPaymentDate    DateTime?      // Final payment date (for loans, etc.)
  categoryId         String
  budgetId           String
  isArchived         Boolean        @default(false)
  createdAt          DateTime       @default(now())

  // Relations
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  budget       Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([budgetId])
  @@index([accountId])
  @@index([categoryId])
  @@index([isArchived])
  @@index([startDate])
}

// Recipient model stores both expense recipients and income senders
// The same table is used for both since they're functionally identical
model Recipient {
  id          String   @id @default(cuid())
  name        String
  householdId String
  createdAt   DateTime @default(now())

  // Relations
  household    Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([name, householdId])
  @@index([householdId])
}

// Transfer model for moving funds between accounts within the same budget
// Transfers do not require a category since they're just moving money
model Transfer {
  id            String   @id @default(cuid())
  fromAccountId String
  toAccountId   String
  amount        Float
  date          DateTime
  notes         String?
  budgetId      String
  createdAt     DateTime @default(now())

  // Relations
  fromAccount Account @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Restrict)
  toAccount   Account @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Restrict)
  budget      Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([date])
}

model Income {
  id                 String         @id @default(cuid())
  name               String
  source             String         // Sender name (e.g., "Employer Name")
  accountId          String         // Account it will land in
  expectedDate       DateTime       // Expected payment date
  recurrenceType     RecurrenceType @default(MONTHLY)
  customIntervalDays Int?
  estimatedAmount    Float
  endDate            DateTime?      // When income ends (optional)
  categoryId         String
  budgetId           String
  isArchived         Boolean        @default(false)
  createdAt          DateTime       @default(now())

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  budget       Budget        @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  transactions Transaction[] // Transactions created from this income

  @@index([budgetId])
  @@index([accountId])
  @@index([categoryId])
  @@index([isArchived])
  @@index([expectedDate])
}

model Invitation {
  id          String   @id @default(cuid())
  email       String
  householdId String
  status      String   @default("PENDING") // PENDING, ACCEPTED, DECLINED, REVOKED
  invitedBy   String   // UserId of inviter
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([email, householdId])
  @@index([email])
  @@index([householdId])
}
